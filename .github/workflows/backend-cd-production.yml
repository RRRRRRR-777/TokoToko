name: Backend CD - Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., staging-latest or commit SHA)'
        required: true
        default: 'staging-latest'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast1
  GKE_CLUSTER: gke-tekutoko-prod
  IMAGE_NAME: tekutoko-api

jobs:
  approve-deployment:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.tekutoko.app
    steps:
      - name: Manual approval required
        run: |
          echo "üöÄ Production deployment requested for image: ${{ github.event.inputs.image_tag }}"
          echo "This step requires manual approval in GitHub Actions UI"

  deploy-to-gke:
    name: Deploy to GKE Production
    runs-on: ubuntu-latest
    needs: approve-deployment
    # TODO: Êú¨Áï™ÈÅãÁî®ÊôÇ„ÅØmain„Éñ„É©„É≥„ÉÅÈôêÂÆö„Å´Êàª„Åô
    # if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Create backup of current deployment
        run: |
          kubectl get deployment tekutoko-api -n tekutoko-prod -o yaml > deployment-backup-$(date +%Y%m%d-%H%M%S).yaml

      - name: Create or update app-secret
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=db-password-prod --project=${{ env.GCP_PROJECT_ID }})
          kubectl create secret generic app-secret \
            --from-literal=db_password="$DB_PASSWORD" \
            --namespace=tekutoko-prod \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply ServiceAccount before migration
        run: |
          kubectl apply -f deploy/kubernetes/base/serviceaccount.yaml -n tekutoko-prod

      - name: Run database migration
        run: |
          kubectl delete job db-migration -n tekutoko-prod --ignore-not-found=true
          kubectl apply -f deploy/kubernetes/overlays/prod/migration-job.yaml
          kubectl wait --for=condition=complete --timeout=5m job/db-migration -n tekutoko-prod || {
            echo "Migration failed"; kubectl logs -l app=tekutoko-migration -n tekutoko-prod -c migration --tail=100; exit 1
          }
          kubectl logs -l app=tekutoko-migration -n tekutoko-prod -c migration --tail=50

      - name: Update Kustomize image tag
        run: |
          cd deploy/kubernetes/overlays/prod
          IMAGE_FULL_PATH="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/tekutoko/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "Updating Kustomize image to: $IMAGE_FULL_PATH"
          kustomize edit set image asia-northeast1-docker.pkg.dev/tokotoko-ea308/tekutoko/tekutoko-api=${IMAGE_FULL_PATH}

      - name: Deploy with Kustomize
        run: |
          kubectl apply -k deploy/kubernetes/overlays/prod

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/tekutoko-api -n tekutoko-prod --timeout=10m

      - name: Verify deployment
        run: |
          kubectl get pods -n tekutoko-prod -l app=tekutoko-api
          kubectl get services -n tekutoko-prod tekutoko-api

      - name: Run smoke tests
        run: |
          EXTERNAL_IP=$(kubectl get service tekutoko-api -n tekutoko-prod -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Testing health endpoint at http://$EXTERNAL_IP/health"
          curl -f http://$EXTERNAL_IP/health || exit 1

          echo "Testing ready endpoint at http://$EXTERNAL_IP/ready"
          curl -f http://$EXTERNAL_IP/ready || exit 1

      - name: Upload deployment backup
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-backup-${{ github.run_number }}
          path: backend/deployment-backup-*.yaml
          retention-days: 90

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [approve-deployment, deploy-to-gke]
    if: always()
    steps:
      - name: Notify success
        if: needs.deploy-to-gke.result == 'success'
        run: |
          echo "‚úÖ Production deployment successful"
          echo "Image: ${{ github.event.inputs.image_tag }}"
          echo "Deployed by: ${{ github.actor }}"
          # TODO: SlackÈÄöÁü•„ÇíËøΩÂä†

      - name: Notify failure
        if: needs.deploy-to-gke.result == 'failure'
        run: |
          echo "‚ùå Production deployment failed"
          echo "Image: ${{ github.event.inputs.image_tag }}"
          echo "See deployment backup artifact for rollback"
          # TODO: SlackÈÄöÁü•„ÇíËøΩÂä†
