name: Backend CD - Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., staging-latest or commit SHA)'
        required: true
        default: 'staging-latest'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast1
  GKE_CLUSTER: gke-tekutoko-prod
  IMAGE_NAME: tekutoko-api

jobs:
  approve-deployment:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Manual approval required
        run: |
          echo "Production deployment requested for image: ${{ github.event.inputs.image_tag }}"
          echo "This step requires manual approval in GitHub Actions UI"

  deploy-to-gke:
    name: Deploy to GKE Production
    runs-on: ubuntu-latest
    needs: approve-deployment
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Ensure namespace exists
        run: |
          kubectl create namespace tekutoko-prod --dry-run=client -o yaml | kubectl apply -f -

      - name: Configure Cloud Armor security policy
        run: |
          POLICY_NAME="tekutoko-prod-security-policy"

          # ポリシーが存在しない場合は作成
          if ! gcloud compute security-policies describe $POLICY_NAME --quiet 2>/dev/null; then
            echo "Creating Cloud Armor security policy..."
            gcloud compute security-policies create $POLICY_NAME \
              --description="Production security policy for TekuToko API"

            # SQLインジェクション防御
            gcloud compute security-policies rules create 900 \
              --security-policy=$POLICY_NAME \
              --expression="evaluatePreconfiguredExpr('sqli-v33-stable')" \
              --action=deny-403 \
              --description="Block SQL injection attacks"

            # XSS防御
            gcloud compute security-policies rules create 901 \
              --security-policy=$POLICY_NAME \
              --expression="evaluatePreconfiguredExpr('xss-v33-stable')" \
              --action=deny-403 \
              --description="Block cross-site scripting attacks"

            # スキャナー/ボットブロック
            gcloud compute security-policies rules create 902 \
              --security-policy=$POLICY_NAME \
              --expression="evaluatePreconfiguredExpr('scannerdetection-v33-stable')" \
              --action=deny-403 \
              --description="Block malicious scanners and bots"

            # プロトコル攻撃防御
            gcloud compute security-policies rules create 903 \
              --security-policy=$POLICY_NAME \
              --expression="evaluatePreconfiguredExpr('protocolattack-v33-stable')" \
              --action=deny-403 \
              --description="Block protocol attacks"

            # レート制限（1分あたり1000リクエスト/IP）
            gcloud compute security-policies rules create 1000 \
              --security-policy=$POLICY_NAME \
              --expression="true" \
              --action=throttle \
              --rate-limit-threshold-count=1000 \
              --rate-limit-threshold-interval-sec=60 \
              --conform-action=allow \
              --exceed-action=deny-429 \
              --enforce-on-key=IP \
              --description="Rate limiting: 1000 requests per minute per IP"

            echo "Cloud Armor security policy created successfully"
          else
            echo "Cloud Armor security policy already exists"
          fi

      - name: Create backup of current deployment
        continue-on-error: true
        run: |
          kubectl get deployment tekutoko-api -n tekutoko-prod -o yaml > deployment-backup-$(date +%Y%m%d-%H%M%S).yaml

      - name: Create or update app-secret
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=db-password-prod --project=${{ env.GCP_PROJECT_ID }})
          FIREBASE_JSON=$(gcloud secrets versions access latest --secret=firebase-service-account --project=${{ env.GCP_PROJECT_ID }})
          kubectl create secret generic app-secret \
            --from-literal=db_password="$DB_PASSWORD" \
            --from-literal=firebase_service_account_json="$FIREBASE_JSON" \
            --namespace=tekutoko-prod \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create or update github-secret for migration
        run: |
          GITHUB_PAT=$(gcloud secrets versions access latest --secret=github-pat --project=${{ env.GCP_PROJECT_ID }})
          kubectl create secret generic github-secret \
            --from-literal=token="$GITHUB_PAT" \
            --namespace=tekutoko-prod \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply ServiceAccount before migration
        run: |
          kubectl apply -f deploy/kubernetes/base/serviceaccount.yaml -n tekutoko-prod

      - name: Run database migration
        run: |
          kubectl delete job db-migration -n tekutoko-prod --ignore-not-found=true
          kubectl apply -f deploy/kubernetes/overlays/prod/migration-job.yaml
          kubectl wait --for=condition=complete --timeout=5m job/db-migration -n tekutoko-prod || {
            echo "Migration failed"; kubectl logs -l app=tekutoko-migration -n tekutoko-prod -c migration --tail=100; exit 1
          }
          kubectl logs -l app=tekutoko-migration -n tekutoko-prod -c migration --tail=50

      - name: Update Kustomize image tag
        run: |
          cd deploy/kubernetes/overlays/prod
          IMAGE_FULL_PATH="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/tekutoko/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "Updating Kustomize image to: $IMAGE_FULL_PATH"
          kustomize edit set image asia-northeast1-docker.pkg.dev/tokotoko-ea308/tekutoko/tekutoko-api=${IMAGE_FULL_PATH}

      - name: Deploy with Kustomize
        run: |
          kubectl apply -k deploy/kubernetes/overlays/prod

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/tekutoko-api -n tekutoko-prod --timeout=10m

      - name: Verify deployment
        run: |
          kubectl get pods -n tekutoko-prod -l app=tekutoko-api
          kubectl get services -n tekutoko-prod tekutoko-api
          kubectl get ingress -n tekutoko-prod tekutoko-api-ingress

      - name: Run smoke tests
        run: |
          # IngressのグローバルIPを取得（Cloudflare経由のHTTPS接続）
          INGRESS_IP=$(kubectl get ingress tekutoko-api-ingress -n tekutoko-prod -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Ingress IP: $INGRESS_IP"

          # Cloudflare経由のドメインでテスト（HTTPS）
          echo "Testing health endpoint at https://tekutoko.rrrrrrr777.com/health"
          curl -f --retry 3 --retry-delay 5 https://tekutoko.rrrrrrr777.com/health || exit 1

          echo "Testing ready endpoint at https://tekutoko.rrrrrrr777.com/ready"
          curl -f --retry 3 --retry-delay 5 https://tekutoko.rrrrrrr777.com/ready || exit 1

      - name: Upload deployment backup
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-backup-${{ github.run_number }}
          path: backend/deployment-backup-*.yaml
          retention-days: 90

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [approve-deployment, deploy-to-gke]
    if: always()
    steps:
      - name: Write job summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy-to-gke.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ github.event.inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY

      - name: Notify success
        if: needs.deploy-to-gke.result == 'success'
        run: |
          echo "Production deployment successful"
          # TODO: Slack通知を追加

      - name: Notify failure
        if: needs.deploy-to-gke.result == 'failure'
        run: |
          echo "Production deployment failed"
          echo "See deployment backup artifact for rollback"
          # TODO: Slack通知を追加
