name: Terraform CI

on:
  pull_request:
    branches:
      - main
      - dev-*
    paths:
      - 'backend/deploy/terraform/**'
      - '.github/workflows/terraform-ci.yml'
  push:
    branches:
      - main
      - dev-*
    paths:
      - 'backend/deploy/terraform/**'
      - '.github/workflows/terraform-ci.yml'

env:
  TERRAFORM_VERSION: '1.9.0'
  TF_IN_AUTOMATION: 'true'

jobs:
  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    defaults:
      run:
        working-directory: ./backend/deploy/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Comment Format  lt
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Terraform Format Check Failed**\n\nPlease run `terraform fmt -recursive` to fix formatting issues.'
            })

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    strategy:
      matrix:
        environment: [dev, staging, prod]
    defaults:
      run:
        working-directory: ./backend/deploy/terraform/envs/${{ matrix.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          project_id  = "tekutoko-${{ matrix.environment }}-test"
          region      = "asia-northeast1"
          zone        = "asia-northeast1-a"
          db_password = "dummy_password_for_validation"
          EOF

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Comment Validate Result
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Terraform Validate Failed (${{ matrix.environment }})**\n\n\`\`\`\n${{ steps.validate.outputs.stdout }}\n\`\`\``
            })

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    strategy:
      matrix:
        environment: [dev]  # PRã§ã¯devç’°å¢ƒã®ã¿planã‚’å®Ÿè¡Œ
    defaults:
      run:
        working-directory: ./backend/deploy/terraform/envs/${{ matrix.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          project_id  = "tekutoko-${{ matrix.environment }}-test"
          region      = "asia-northeast1"
          zone        = "asia-northeast1-a"
          db_password = "dummy_password_for_plan"
          EOF

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      - name: Comment Plan Result
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### Terraform Plan Result (${{ matrix.environment }})

            #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
            #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  terraform-security-scan:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/deploy/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: backend/deploy/terraform
          soft_fail: true
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  terraform-docs:
    name: Terraform Docs Auto-Update
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate docs for all modules
        uses: terraform-docs/gh-actions@v1.1.0
        with:
          working-dir: backend/deploy/terraform
          output-file: README.md
          output-method: inject
          find-dir: modules
          git-push: true
          git-commit-message: "docs(terraform): ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«READMEè‡ªå‹•æ›´æ–°"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, terraform-plan, terraform-security-scan]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          # å¿…é ˆã‚¸ãƒ§ãƒ–ã®ãƒã‚§ãƒƒã‚¯ï¼ˆfmt, validate, security-scanï¼‰
          if [ "${{ needs.terraform-fmt.result }}" != "success" ] || \
             [ "${{ needs.terraform-validate.result }}" != "success" ] || \
             [ "${{ needs.terraform-security-scan.result }}" != "success" ]; then
            echo "âŒ Terraform CI checks failed"
            exit 1
          fi

          # terraform-planã¯PRã®ã¿å®Ÿè¡Œãªã®ã§skippedã‚’è¨±å®¹
          if [ "${{ needs.terraform-plan.result }}" == "failure" ]; then
            echo "âŒ Terraform Plan failed"
            exit 1
          fi

          echo "âœ… All Terraform CI checks passed"
